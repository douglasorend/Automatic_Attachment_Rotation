<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:AutoRotation</id>
<name>Automatic Attachment Rotation</name>
<version>1.0</version>

<file name="$sourcedir/Subs-Graphics.php">
	<operation>
		<search position="before"><![CDATA[$sizes = @getimagesize($destination);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		image_rotate_flip($destination, $src_format, $sizes, $preferred_format);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$sizes = @getimagesize($source);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		image_rotate_flip($source, $src_format, $sizes, $preferred_format);]]></add>
	</operation>
	<operation>
		<search position="end" />
		<add><![CDATA[
function image_rotate_flip($filename, $format, $preferred_format)
{
	global $sourcedir;

	// A known and supported format?
	if (!$format || !function_exists('imagecreatefrom' . $format))
		return false;
		
	// Make sure it is an orientation that we can fix:
	if (function_exists('exif_read_data'))
	{
		// Find this with native code if the function already exists:
		$exif = @exif_read_data($filename);
		$orientation = isset($exif['IFD0']['Orientation']) ? $exif['IFD0']['Orientation'] : 0;
	}
	else
	{
		// Find this with the class if the function doesn't exist:
		require_once($sourcedir . '/Class-exifReader.php');
		$er = new phpExifReader($filename);
		$er->processFile();
		$orientation = isset($er->ImageInfo[TAG_ORIENTATION]) ? $er->ImageInfo[TAG_ORIENTATION] : 0;
	}
	if ($orientation < 2)
		return false;

	// Load up the image and rotate the image so that it is correct:
	$imagecreatefrom = 'imagecreatefrom' . $format;
	if (!$src_img = @$imagecreatefrom($filename))
		return false;
	switch($orientation)
	{
		case 2:
			$src_img = imageflip($scr_img, IMG_FLIP_HORIZONTAL);
			break;
		case 3:
			$src_img = imagerotate($src_img, 180, 0);
			break;
		case 4:
			$src_img = imageflip($scr_img, IMG_FLIP_VERTICAL);
			break;
		case 5:
			$src_img = imageflip($scr_img, IMG_FLIP_VERTICAL);
			$src_img = imagerotate($src_img, -90, 0);
			break;
		case 6:
			$src_img = imagerotate($src_img, -90, 0);
			break;
		case 7:
			$src_img = imageflip($scr_img, IMG_FLIP_HORIZONTAL);
			$src_img = imagerotate($src_img, -90, 0);
			break;
		case 8:
			$src_img = imagerotate($src_img, 90, 0);
			break;
	}

	// Save the image as ...
	if (!empty($preferred_format) && ($preferred_format == 3) && function_exists('imagepng'))
		$success = imagepng($src_img, $filename);
	elseif (!empty($preferred_format) && ($preferred_format == 1) && function_exists('imagegif'))
		$success = imagegif($src_img, $filename);
	elseif (function_exists('imagejpeg'))
		$success = imagejpeg($src_img, $filename);
	return $success;
}
]]></add>
	</operation>
</file>
</modification>