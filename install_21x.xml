<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:AutoRotation</id>
<name>Automatic Attachment Rotation</name>
<version>3.4</version>

<file name="$sourcedir/Display.php">
	<!-- Display function -->
	<operation>
		<search position="after"><![CDATA[// Fetch attachments.]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-AutoRotation.php');

		]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[IFNULL(thumb.id_attach, 0) AS id_thumb, thumb.width AS thumb_width, thumb.height AS thumb_height]]></search>
		<add><![CDATA[a.proper_rotation AS img_rotation, ]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[IFNULL(thumb.id_attach, 0) AS id_thumb, thumb.width AS thumb_width, thumb.height AS thumb_height]]></search>
		<add><![CDATA[,
					thumb.proper_rotation AS thumb_rotation, thumb.id_folder AS thumb_folder, 
					thumb.file_hash AS thumb_hash, thumb.filename AS thumb_name]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$temp[$row['id_attach']] = $row;]]></search>
		<add><![CDATA[$temp[$row['id_attach']] = AutoRotation_Display($row);]]></add>
	</operation>

	<!-- Download function -->
	<operation>
		<search position="before"><![CDATA[global $txt, $modSettings, $user_info, $context, $topic, $smcFunc]]></search>
		<add><![CDATA[, $sourcedir]]></add>
	</operation>
	<operation>
		<search positon="before"><![CDATA[// Some defaults that we need.]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-AutoRotation.php');
	
	]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[SELECT a.id_folder, a.filename, a.file_hash, a.fileext, a.id_attach, a.attachment_type, a.mime_type, a.approved, m.id_member]]></search>
		<add><![CDATA[, a.proper_rotation]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$is_approved, $id_member) = $smcFunc['db_fetch_row']($request);]]></search>
		<add><![CDATA[$is_approved, $id_member, $proper_rotation) = $smcFunc['db_fetch_row']($request);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$filename = getAttachmentFilename($real_filename, $_REQUEST['attach'], $id_folder, false, $file_hash);]]></search>
		<add><![CDATA[
	if (!$proper_rotation && (isset($_REQUEST['type']) && $_REQUEST['type'] != 'avatar'))
		AutoRotation_Download($filename, $_REQUEST['attach'], $attachment_type);]]></add>
	</operation>
	
	<!-- loadAttachmentContext function -->
	<operation>
		<search position="after"><![CDATA[$attachmentData[$i] = array(]]></search>
		<add><![CDATA[$time = filemtime(getAttachmentFilename($attachment['filename'], $attachment['id_attach'], $attachment['id_folder'], false, $attachment['file_hash']));

			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['href' => $scripturl . '?action=dlattach;topic=' . $topic . '.0;attach=' . $attachment['id_attach']]]></search>
		<add><![CDATA[ . ';ts=' . $time]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['link' => '<a href="' . $scripturl . '?action=dlattach;topic=' . $topic . '.0;attach=' . $attachment['id_attach'] . ']]></search>
		<add><![CDATA[;ts=' . $time . ']]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[
				// Only adjust dimensions on successful thumbnail creation.]]></search>
		<add><![CDATA[else
					$thumb_realname = getAttachmentFilename($attachment['thumb_name'], $attachment['id_thumb'], $attachment['thumb_folder'], false, $attachment['thumb_hash']);
					
				// Get timestamp for thumbnail image:
				$time = !empty($thumb_realname) && file_exists($thumb_realname) ? filemtime($thumb_realname) : false;
]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['href' => $scripturl . '?action=dlattach;topic=' . $topic . '.0;attach=' . $attachment['id_thumb'] . ';image']]></search>
		<add><![CDATA[ . ';ts=' . $time]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageAttachments.php">
	<!-- ManageAttachments function -->
	<operation>
		<search position="replace"><![CDATA['remove' => 'RemoveAttachment',]]></search>
		<add><![CDATA['remove' => 'AutoRotation_Remove',]]></add>
	</operation>
	
	<!-- BrowseFiles function -->
	<operation>
		<search position="replace"><![CDATA[	$link .= sprintf('%1$s?action=dlattach;topic=%2$d.0;attach=%3$d', $scripturl, $rowData['id_topic'], $rowData['id_attach']);]]></search>
		<add><![CDATA[{
							$time = filemtime(getAttachmentFilename($rowData['filename'], $rowData['id_attach'], $rowData['id_folder'], false, $rowData['file_hash']));
							$link .= sprintf('%1$s?action=dlattach;topic=%2$d.0;attach=%3$d;ts=%4$d', $scripturl, $rowData['id_topic'], $rowData['id_attach'], $time);
						}]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA['check' => array(]]></search>
		<add><![CDATA['orientation' => array(
				'header' => array(
					'value' => $txt['img_orientation'],
					'style' => 'width: 1%',
				),
				'data' => array(
					'function' => function ($rowData) use ($txt)
					{
						$str = sprintf('<select id="orient[%1$d]" name="orient[%1$d]"><option value="0">' . $txt['img_orientation1'] . '</option><option value="2">' . $txt['img_orientation2'] . '</option><option value="3">' . $txt['img_orientation3'] . '</option><option value="4">' . $txt['img_orientation4'] . '</option><option value="5">' . $txt['img_orientation5'] . '</option><option value="6">' . $txt['img_orientation6'] . '</option><option value="7">' . $txt['img_orientation7'] . '</option><option value="8">' . $txt['img_orientation8'] . '</option></select>', $rowData['id_attach']);
						return !empty($rowData['width']) && !empty($rowData['height']) ? $str : false;
					},
					'style' => 'text-align: center',
				),
			),
			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[// Create the list.]]></search>
		<add><![CDATA[
	if ($context['browse_type'] == 'avatars')
		unset($listOptions['columns']['orientation']);]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[$txt['quickmod_delete_selected'] . ]]></search>
		<add><![CDATA[$txt['img_rotate'] . ' &amp; ' . ]]></add>
	</operation>

	<!-- list_getFiles function -->
	<operation>
		<search position="after"><![CDATA[a.id_attach, a.filename, a.file_hash, a.attachment_type, a.size, a.width, a.height, a.downloads, mf.subject, t.id_board]]></search>
		<add><![CDATA[a.id_folder, ]]></add>
	</operation>
</file>
<file name="$sourcedir/Post.php">
	<!-- Post function -->
	<operation>
		<search position="before"><![CDATA[global $sourcedir, $smcFunc, $language;

	loadLanguage('Post');]]></search>
		<add><![CDATA[
	loadLanguage('AutoRotation');]]></add>
	</operation>

	<!-- Post2 function -->
	<operation>
		<search position="before"><![CDATA[require_once($sourcedir . '/Subs-Post.php');
	loadLanguage('Post');]]></search>
		<add><![CDATA[
	loadLanguage('AutoRotation');]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// ...or attach a new file...]]></search>
		<add><![CDATA[// ...or rotate an existing attachment...
	if (isset($_REQUEST['msg'], $_POST['orient']) && allowedTo('post_attachment'))
	{
		require_once($sourcedir . '/Subs-AutoRotation.php');
		AutoRotation_Rotate();
	}
	
	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Graphics.php">
	<!-- resizeImageFile function -->
	<operation>
		<search position="before"><![CDATA[require_once($sourcedir . '/Subs-Package.php');]]></search>
		<add><![CDATA[
	require_once($sourcedir . '/Subs-AutoRotation.php');]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[getimagesize($destination);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		AutoRotation_Process($destination);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[getimagesize($source);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		AutoRotation_Process($source);]]></add>
	</operation>
</file>
<file name="$themedir/ManageAttachments.template.php">
	<operation>
		<search position="before"><![CDATA[<input type="hidden" name="type" value="avatars">
				<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '">
				<input type="hidden" name="sa" value="byAge">]]></search>
		<add><![CDATA[
			</form>
		</div>
		<div class="cat_bar">
			<h3 class="catbg">', $txt['attachment_pruning'], '</h3>
		</div>
		<div class="windowbg2">
			<form action="', $scripturl, '?action=admin;area=manageattachments;sa=clearflags;', $context['session_var'], '=', $context['session_id'], '" method="post" accept-charset="', $context['character_set'], '">
				<p>', $txt['attachment_clear_rotation_desc'], '</p>
				<input type="submit" name="submit" value="', $txt['attachment_clear_rotation_button'], '" class="button_submit" />]]></add>
	</operation>
</file>
<file name="$themedir/Post.template.php">
	<operation>
		<search position="before"><![CDATA[class="input_check"> ', $attachment['name'], ]]></search>
		<add><![CDATA[' (', $txt['img_orientation'], ': ', sprintf('<select id="orient[%1$d]" name="orient[%1$d]"><option value="0">' . $txt['img_orientation1'] . '</option><option value="2">' . $txt['img_orientation2'] . '</option><option value="3">' . $txt['img_orientation3'] . '</option><option value="4">' . $txt['img_orientation4'] . '</option><option value="5">' . $txt['img_orientation5'] . '</option><option value="6">' . $txt['img_orientation6'] . '</option><option value="7">' . $txt['img_orientation7'] . '</option><option value="8">' . $txt['img_orientation8'] . '</option></select>', $attachment['id']), ')', ]]></add>
	</operation>
</file>
</modification>