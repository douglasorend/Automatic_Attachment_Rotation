<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:AutoRotation</id>
<name>Automatic Attachment Rotation</name>
<version>2.0</version>

<file name="$sourcedir/Display.php">
	<!-- Display function -->
	<operation>
		<search position="after"><![CDATA[// Fetch attachments.]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-AutoRotation.php');

		]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[a.id_attach, a.id_folder, a.id_msg, a.filename, a.file_hash, IFNULL(a.size, 0) AS filesize, a.downloads, a.approved,]]></search>
		<add><![CDATA[
					a.proper_rotation AS img_rotation, thumb.proper_rotation AS thumb_rotation, thumb.fileext as thumb_ext, a.fileext as file_ext,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$temp[$row['id_attach']] = $row;]]></search>
		<add><![CDATA[$temp[$row['id_attach']] = AutoRotation_Display($row);]]></add>
	</operation>

	<!-- Download function -->
	<operation>
		<search position="before"><![CDATA[global $txt, $modSettings, $user_info, $scripturl, $context, $sourcedir, $topic, $smcFunc]]></search>
		<add><![CDATA[, $sourcedir]]></add>
	</operation>
	<operation>
		<search positon="before"><![CDATA[// Some defaults that we need.]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-AutoRotation.php');
	
	]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[SELECT id_folder, filename, file_hash, fileext, id_attach, attachment_type, mime_type, approved, id_member]]></search>
		<add><![CDATA[, proper_rotation]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[SELECT a.id_folder, a.filename, a.file_hash, a.fileext, a.id_attach, a.attachment_type, a.mime_type, a.approved, m.id_member]]></search>
		<add><![CDATA[, a.proper_rotation]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$is_approved, $id_member) = $smcFunc['db_fetch_row']($request);]]></search>
		<add><![CDATA[$is_approved, $id_member, $proper_rotation) = $smcFunc['db_fetch_row']($request);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$filename = getAttachmentFilename($real_filename, $_REQUEST['attach'], $id_folder, false, $file_hash);]]></search>
		<add><![CDATA[
	if (!$proper_rotation && (isset($_REQUEST['type']) && $_REQUEST['type'] != 'avatar'))
		AutoRotation_Download($filename, $file_ext, $_REQUEST['attach'], $attachment_type);]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageAttachments.php">
	<!-- ManageAttachments function -->
	<operation>
		<search position="replace"><![CDATA['remove' => 'RemoveAttachment',]]></search>
		<add><![CDATA['remove' => 'AutoRotation_Rotate',]]></add>
	</operation>
	
	<!-- BrowseFiles function -->
	<operation>
		<search position="after"><![CDATA['check' => array(]]></search>
		<add><![CDATA['orientation' => array(
				'header' => array(
					'value' => $txt['img_orientation'],
					'style' => 'width: 1%',
				),
				'data' => array(
					'function' => create_function('$rowData', '
						$str = \'<select id="orient[%1$d]" name="orient[%1$d]"><option value="0">' . $txt['img_orientation1'] . '</option><option value="2">' . $txt['img_orientation2'] . '</option><option value="3">' . $txt['img_orientation3'] . '</option><option value="4">' . $txt['img_orientation4'] . '</option><option value="5">' . $txt['img_orientation5'] . '</option><option value="6">' . $txt['img_orientation6'] . '</option><option value="7">' . $txt['img_orientation7'] . '</option><option value="8">' . $txt['img_orientation8'] . '</option></select>\';
						return !empty($rowData[\'width\']) && !empty($rowData[\'height\']) ? $str : false;
					'),
					'style' => 'text-align: center',
				),
			),
			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[// Create the list.]]></search>
		<add><![CDATA[
	if ($context['browse_type'] != 'attachments')
		unset($listOptions['columns']['orientation']);]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[$txt['quickmod_delete_selected'] . ]]></search>
		<add><![CDATA[$txt['img_rotate'] . ' &amp; ' . ]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Graphics.php">
	<!-- resizeImageFile function -->
	<operation>
		<search position="before"><![CDATA[require_once($sourcedir . '/Subs-Package.php');]]></search>
		<add><![CDATA[
	require_once($sourcedir . '/Subs-AutoRotation.php');]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$sizes = @getimagesize($destination);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		AutoRotation_Process($source, $src_format, $preferred_format);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$sizes = @getimagesize($source);]]></search>
		<add><![CDATA[
		$src_format = isset($sizes[2]) && isset($default_formats[$sizes[2]]) ? $default_formats[$sizes[2]] : false;
		AutoRotation_Process($source, $src_format, $preferred_format);]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Post.php">
	<operation>
		<search position="before"><![CDATA[UPDATE {db_prefix}attachments
			SET id_msg = {int:id_msg}]]></search>
		<add><![CDATA[, proper_rotation = 1]]></add>
	</operation>
</file>
</modification>